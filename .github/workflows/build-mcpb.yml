name: Build n8n-dev-bridge MCPB Bundle

on:
  push:
    branches: [ main, develop, feat/* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  MCPB_NAME: 'n8n-dev-bridge'
  AUTH_TOKEN: 'Bearer zxT94kE8pLr62UNqV1dCB'

jobs:
  build-mcpb:
    runs-on: windows-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        registry-url: 'https://registry.npmjs.org/'
        cache: 'npm'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        Write-Host "Dependencies installed successfully" -ForegroundColor Green
      shell: powershell

    - name: Set version from ref
      shell: powershell
      run: |
        $version = if ($env:GITHUB_REF -match "refs/tags/v(.+)") { 
          $matches[1] 
        } elseif ($env:GITHUB_REF_NAME) { 
          "1.0.0-$($env:GITHUB_REF_NAME -replace '[^a-zA-Z0-9]', '')" 
        } else { 
          "1.0.0-dev.$env:GITHUB_RUN_NUMBER" 
        }
        
        Write-Host "Setting version: $version" -ForegroundColor Cyan
        echo "MCPB_VERSION=$version" >> $env:GITHUB_ENV

    - name: Run automated MCPB build
      shell: powershell
      env:
        GITHUB_REF_NAME: ${{ env.MCPB_VERSION }}
      run: |
        Write-Host "Starting n8n-dev-bridge MCPB build process..." -ForegroundColor Cyan
        Write-Host "Version: $env:MCPB_VERSION" -ForegroundColor Yellow
        
        try {
          # Run the build script
          npm run build
          
          if ($LASTEXITCODE -ne 0) {
            throw "Build script failed with exit code $LASTEXITCODE"
          }
          
          # Verify the bundle was created
          $bundleFile = "$env:MCPB_NAME.mcpb"
          if (-not (Test-Path $bundleFile)) {
            throw "MCPB bundle file not found: $bundleFile"
          }
          
          $bundleSize = (Get-Item $bundleFile).Length
          Write-Host "‚úì MCPB bundle created successfully!" -ForegroundColor Green
          Write-Host "  File: $bundleFile" -ForegroundColor Gray
          Write-Host "  Size: $([math]::Round($bundleSize / 1KB, 2)) KB" -ForegroundColor Gray
          Write-Host "  Note: Simulated bundle format (until MCPB CLI available)" -ForegroundColor Yellow
          
          # Set output for artifact upload
          echo "BUNDLE_PATH=$bundleFile" >> $env:GITHUB_ENV
          echo "BUNDLE_SIZE=$bundleSize" >> $env:GITHUB_ENV
          
        } catch {
          Write-Error "Build failed: $($_.Exception.Message)"
          Write-Host "Build logs:" -ForegroundColor Yellow
          Get-Content "bundle/npm-debug.log" -ErrorAction SilentlyContinue
          exit 1
        }

    - name: Generate installation files
      shell: powershell
      run: |
        Write-Host "Generating installation and setup files..." -ForegroundColor Cyan
        
        # Ensure credential setup script is available
        if (Test-Path "scripts/setup-windows-credentials.ps1") {
          Copy-Item "scripts/setup-windows-credentials.ps1" "setup-windows-credentials.ps1"
          Write-Host "‚úì Credential setup script ready" -ForegroundColor Green
        } else {
          Write-Warning "Credential setup script not found"
        }
        
        # Generate installation guide
        $instructions = @"
# n8n-dev-bridge MCPB Bundle - Installation Guide

## Quick Installation
1. Download ``$env:MCPB_NAME.mcpb`` and ``setup-windows-credentials.ps1``
2. Run PowerShell as Administrator: ``.\setup-windows-credentials.ps1``
3. Drag ``$env:MCPB_NAME.mcpb`` into Claude Desktop ‚Üí Settings ‚Üí Extensions
4. Remove old JSON configuration from ``claude_desktop_config.json``

## What This Bundle Does
Converts your n8n-dev-bridge JSON configuration to a secure MCPB bundle:

**Features:**
- Secure Bearer token storage via Windows Credential Manager
- One-click installation in Claude Desktop
- HTTP transport to Railway-hosted n8n instance
- Full n8n workflow and node management capabilities
- Automatic error handling and diagnostics

**Configuration Details:**
- Endpoint: ``https://czlonkowskin8n-mcp-railwaylatest-dev.up.railway.app/mcp``
- Transport: HTTP-only via mcp-remote
- Authentication: Bearer token (securely stored)
- Version: $env:MCPB_VERSION

## Testing Your Installation
After installation, test in Claude Desktop with:
- "Check n8n health status"
- "List my n8n workflows" 
- "Show available n8n nodes"

## Troubleshooting
- Ensure PowerShell is running as Administrator for credential setup
- Check Windows Credential Manager for stored tokens
- Report issues: https://github.com/mapachekurt/n8n-dev-bridge-mcpb/issues

Built: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
Commit: $env:GITHUB_SHA
Build: #$env:GITHUB_RUN_NUMBER
"@
        
        $instructions | Out-File -FilePath "INSTALLATION.md" -Encoding UTF8
        Write-Host "‚úì Installation guide generated" -ForegroundColor Green

    - name: Upload MCPB bundle artifacts
      uses: actions/upload-artifact@v4
      with:
        name: n8n-dev-bridge-mcpb-${{ env.MCPB_VERSION }}-build${{ github.run_number }}
        path: |
          ${{ env.BUNDLE_PATH }}
          setup-windows-credentials.ps1
          INSTALLATION.md
        retention-days: 30
        compression-level: 9

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.BUNDLE_PATH }}
          setup-windows-credentials.ps1
          INSTALLATION.md
        name: n8n-dev-bridge MCPB Bundle v${{ env.MCPB_VERSION }}
        tag_name: ${{ github.ref_name }}
        body: |
          # n8n-dev-bridge MCPB Bundle v${{ env.MCPB_VERSION }}

          **Ready-to-install Claude Desktop extension for n8n Railway integration**

          ## üì¶ Files in this release:
          - `${{ env.MCPB_NAME }}.mcpb` - MCPB bundle for Claude Desktop (${{ env.BUNDLE_SIZE }} bytes)
          - `setup-windows-credentials.ps1` - Windows Credential Manager setup script
          - `INSTALLATION.md` - Complete installation and usage guide

          ## üöÄ Quick Start:
          1. **Download** all three files from this release
          2. **Run** `setup-windows-credentials.ps1` as Administrator  
          3. **Install** the `.mcpb` file in Claude Desktop Extensions
          4. **Remove** old JSON config from `claude_desktop_config.json`

          ## ‚ú® Features:
          - üîê Secure Bearer token storage (Windows Credential Manager)
          - üåê HTTP transport to Railway-hosted n8n instance  
          - üõ†Ô∏è Full n8n workflow and node management
          - üéØ One-click installation and updates
          - üìä Enhanced error handling and diagnostics

          ## üîó Configuration:
          - **Endpoint:** `https://czlonkowskin8n-mcp-railwaylatest-dev.up.railway.app/mcp`
          - **Transport:** HTTP-only via mcp-remote
          - **Auth:** Bearer token (Windows secure storage)

          See `INSTALLATION.md` for detailed setup instructions and troubleshooting.

          ---
          **Build Info:** Commit ${{ github.sha }} | Build #${{ github.run_number }} | $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Summary
      shell: powershell
      run: |
        Write-Host ""
        Write-Host "üéâ n8n-dev-bridge MCPB Build Summary" -ForegroundColor Green
        Write-Host "====================================" -ForegroundColor Green
        Write-Host "Version: $env:MCPB_VERSION" -ForegroundColor Cyan
        Write-Host "Bundle: $env:BUNDLE_PATH ($env:BUNDLE_SIZE bytes)" -ForegroundColor Cyan
        Write-Host "Repository: https://github.com/mapachekurt/n8n-dev-bridge-mcpb" -ForegroundColor Cyan
        Write-Host ""
        
        if ($env:GITHUB_REF -match "refs/tags/v") {
          Write-Host "üöÄ Release created: https://github.com/mapachekurt/n8n-dev-bridge-mcpb/releases/tag/$env:GITHUB_REF_NAME" -ForegroundColor Green
        } else {
          Write-Host "üíæ Artifact uploaded to: https://github.com/mapachekurt/n8n-dev-bridge-mcpb/actions/runs/$env:GITHUB_RUN_ID" -ForegroundColor Yellow
        }
        
        Write-Host ""
        Write-Host "Next steps for users:" -ForegroundColor White
        Write-Host "1. Download the MCPB bundle and setup script" -ForegroundColor Gray
        Write-Host "2. Run setup-windows-credentials.ps1 as Administrator" -ForegroundColor Gray  
        Write-Host "3. Install .mcpb file in Claude Desktop Extensions" -ForegroundColor Gray
        Write-Host "4. Test with: 'Check n8n health status'" -ForegroundColor Gray
